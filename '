import { TanStackDevtools } from "@tanstack/react-devtools";
import { FormApi, formOptions, useForm } from "@tanstack/react-form";
import { FormDevtoolsPlugin } from "@tanstack/react-form-devtools";
import {
    QueryClient,
    QueryClientProvider,
    useMutation,
} from "@tanstack/react-query";
import axios from "axios";
import React from "react";
import { formSignal } from "./store";

import TitleField from "./titleField/TitleField";

interface Ticket {
    title: string;
    body: string | null;
}

function FormSection(): React.JSX.Element {
    const defaultTicket: Ticket = { title: "", body: null };
    const formOpts = formOptions({
        defaultValues: defaultTicket,
    });
    const saveUserMutation = useMutation({
        mutationFn: async function (value: Ticket) {
            await axios({
                method: "post",
                url: "/api/tickets/post",
                data: value,
                headers: {
                    "Content-Type": "multipart/form-data",
                },
            });
        },
    });

    const form = useForm({
        ...formOpts,
        onSubmit: async function ({ formApi, value }) {
            console.log(value);
            await saveUserMutation.mutateAsync(value);
            formApi.reset();
        },
    });

    formSignal.value = form;
    return (
        <section>
            <form
                onSubmit={function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    form.handleSubmit();
                    window.location.href = "/tickets";
                }}
            >
                <TitleField />
                <form.Subscribe
                    selector={function (state) {
                        return [state.canSubmit, state.isSubmitting];
                    }}
                    children={function ([canSubmit, isSubmitting]) {
                        return (
                            <>
                                <button type="submit" disabled={!canSubmit}>
                                    {isSubmitting ? "..." : "Submit"}
                                </button>
                            </>
                        );
                    }}
                />
            </form>
        </section>
    );
}
export default function CreateTicketWrapper(): React.JSX.Element {
    const queryClient = new QueryClient();
    return (
        <QueryClientProvider client={queryClient}>
            <FormSection />
            <TanStackDevtools plugins={[FormDevtoolsPlugin()]} />
        </QueryClientProvider>
    );
}
